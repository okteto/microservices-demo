name: microservices-demo

# The build section defines how to build the images of your development environment
# More info: https://www.okteto.com/docs/reference/manifest/#build
build:

  # You can use the following env vars to refer to this image in your deploy commands:
  #  - OKTETO_BUILD_RESULT_REGISTRY: image registry
  #  - OKTETO_BUILD_RESULT_REPOSITORY: image repo
  #  - OKTETO_BUILD_RESULT_IMAGE: image name
  #  - OKTETO_BUILD_RESULT_TAG: image tag
  result:
    context: result
    dockerfile: result/Dockerfile

  # You can use the following env vars to refer to this image in your deploy commands:
  #  - OKTETO_BUILD_VOTE_REGISTRY: image registry
  #  - OKTETO_BUILD_VOTE_REPOSITORY: image repo
  #  - OKTETO_BUILD_VOTE_IMAGE: image name
  #  - OKTETO_BUILD_VOTE_TAG: image tag
  vote:
    context: vote
    dockerfile: vote/Dockerfile

  worker:
    context: worker
    dockerfile: worker/Dockerfile

deploy:
  - helm repo add bitnami https://charts.bitnami.com/bitnami
  - helm upgrade --install postgresql bitnami/postgresql -f postgresql/values.yml --version 10.16.2
  - helm upgrade --install kafka bitnami/kafka -f kafka/values.yml --version 14.5.0
  - okteto build -t okteto.dev/result:${OKTETO_GIT_COMMIT} result
  - helm upgrade --install result result/chart --set image.tag=${OKTETO_GIT_COMMIT}
  - okteto build -t okteto.dev/vote:${OKTETO_GIT_COMMIT} vote
  - helm upgrade --install vote vote/chart --set image.tag=${OKTETO_GIT_COMMIT}
  - okteto build -t okteto.dev/worker:${OKTETO_GIT_COMMIT} worker
  - okteto build -t okteto.dev/worker:dev --target dev worker
  - helm upgrade --install worker worker/chart --set image.tag=${OKTETO_GIT_COMMIT}

dev:
  result:
    command:
      - sh
      - -c
      - nodemon server.js
    sync:
      - result:/app
    persistentVolume:
      enabled: false
  vote:
    command:
      - sh
      - -c
      - mvn spring-boot:run
    sync:
      - vote:/app
    forward:
      - 5005:5005
    persistentVolume:
      enabled: false
  worker:
    image: okteto.dev/worker:dev
    command: bash
    securityContext:
      capabilities:
        add:
          - SYS_PTRACE
    sync:
      - worker:/app
    forward:
      - 2345:2345
    persistentVolume:
      enabled: false

